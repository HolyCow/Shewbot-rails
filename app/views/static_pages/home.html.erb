
<row>
	<div class="col-md-6">
		<h2 id="currentshowtitle"><%= @current_show_title %></h2>
	</div>
	<div class="col-md-6">
		<p class="pull-right">
			<span id="viewers">1 person</span> viewing this page
			<br/>
			Refresh in <span id="refresh">10</span>
		</p>
	</div>
</row>

<div id="titles" class="row">Loading...</div>


<script id="headerTemplate" type="text/template">
<tr>
	<th>Vote</th>
	<th>Title</th>
	<th>Submitter</th>
	<th>Votes</th>
</tr>
</script>
<script id="titleTemplate" type="text/template">
	<td>
		<%% if (!voteid) { %>
			<span class="vote glyphicon glyphicon-arrow-up" id="<%%= id %>"></span>
		<%% } %>
	</td>
	<td><%%- title %></td>
	<td><%%= irc_user.name %></td>
	<td><%%= votes_count %></td>
</script>
<script>var titles = []</script>
<script>
	(function ($) {

	    var Shewbot = {};
	    window.Shewbot = Shewbot;

	    Shewbot.Title = Backbone.Model.extend({
	    });

	    Shewbot.Titles = Backbone.Collection.extend({
	        url: "/titles.json",
	        model: Shewbot.Title,
	        comparator: function(a, b) {
	            return a.get("votes_count") < b.get("votes_count") ?  1
	                 : a.get("votes_count") > b.get("votes_count") ? -1
	                 : a.get("id") < b.get("id") ?  1
	                 : a.get("id") > b.get("id") ? -1
	                 :                              0;
	        }
	    })

	    Shewbot.TitleView = Backbone.View.extend({
	        tagName: "tr",
	        className: "title",
	        events: {},
	        template: $("#titleTemplate").html(),

	        render: function() {
	            var tmpl = _.template(this.template);

	            this.$el.html(tmpl(this.model.toJSON()));
	            //console.log(this);
	            return this;
	        }
	    });

	    Shewbot.TitleCollectionView = Backbone.View.extend({
	        tagName: "table",
	        className: "table",
	        template: $("#headerTemplate").html(),
	        initialize: function( titleSet ) {
	            this.titles = new Shewbot.Titles ( titleSet );
	            this.titles.on('sync', this.render, this);
	            this.titles.on('all', function() {
//	                console.log("event on title collection", arguments);
	            });
	            this.titles.fetch();
	            this.interval = window.setInterval( _.bind( function() { this.titles.fetch() }, this ), 10000);
	        },
	        render: function() {
	            this.$el.empty();
	            this.$el.append(this.template);

	            this.titles.each(function(title) {
	                var view = new Shewbot.TitleView({model: title});
	                this.$el.append(view.render().el);
	            }, this);

	            window.timercountdown = 10;

	            return this;
	        },


	    });

	    Shewbot.boot = function(container, titleSet ) {
	        container = $(container);
	        titleTable = new Shewbot.TitleCollectionView( titleSet );
	        container.empty();
	        container.append(titleTable.render().el);
	    }

	} (jQuery));
</script>
<script>
	$(document).on("click", "span.vote", function(event) {
		//console.log("click" + event.target.id, this);
		$.get("/title/" + event.target.id + "/upvote");
		$(this).hide();
	});

	$(document).on("touchend", "span.vote", function(event) {
		//console.log("click" + event.target.id, this);
		$.get("/title/" + event.target.id + "/upvote");
		$(this).hide();
	});

	$(function() {
		var titleTable = Shewbot.boot($("#titles"), titles);
	});

	function showupdate() {
		$.getJSON(  
		    '/shows/current',  
		    {},  
		    function(json) {  
		        $("#currentshowtitle").html(json.title);
		    }  
		);
	}
	setInterval(showupdate, 10000);

	function visitorupdate() {
		$.getJSON(  
		    '/sessions/visitor_count',  
		    {},  
		    function(json) {
		    		updatetext = json.visitors + ' people';
		    		if (json.visitors === 1) {
		    			updatetext = json.visitors + ' person';
		    		}
		        $("#viewers").html(updatetext);
		    }  
		);
	}
	setInterval(visitorupdate, 10000);

	function refreshupdate() {
		window.timercountdown = window.timercountdown - 1
    $("#refresh").html(window.timercountdown);
	}

	window.timercountdown = 10;

	setInterval(refreshupdate, 1000);

</script>